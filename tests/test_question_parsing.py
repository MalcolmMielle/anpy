# -*- coding: utf-8 -*-

import unittest

import requests

from anpy.parsing.question_parser import parse_question
from anpy.parsing.question_search_result_parser import parse_question_search_result


class QuestionParsingTest(unittest.TestCase):
    maxDiff = None

    def test_question_parsing(self):
        expected_result = {"source": "http://questions.assemblee-nationale.fr/q14/14-67716QE.htm", "legislature": "14", "type": "QE", "numero": "67716", "date_question": "2014-10-28", "date_retrait": "", "date_reponse": "", "date_signalement": "", "date_cht_attr": "", "page_question": "8856", "page_reponse": "", "ministere_attribue": "Affaires sociales, santé et droits des femmes", "ministere_interroge": "Affaires sociales, santé et droits des femmes", "tete_analyse": "soins palliatifs", "analyse": "formation universitaire", "rubrique": "santé", "question": "Mme Michèle Delaunay attire l\'attention de Mme la ministre des affaires sociales, de la santé et des droits des femmes sur la création d\'une filière universitaire de médecine palliative. Il existe aujourd\'hui en France 120 unités de soins palliatifs, 350 équipes mobiles de soins palliatifs et 4 000 lits identifiés de soins palliatifs ; pourtant, aucune filière de médecine palliative ne prépare spécifiquement les médecins et équipes soignantes à ce domaine qui est amené à se développer dans les années à venir. Des diplômes d\'études spécialisées (DES) « urgence » et « gériatrie » vont être prochainement créés et pour les professionnels qui exercent dans les soins palliatifs, il est important que voit le jour également un DES « médecine palliative » pour répondre à un véritable besoin. Il est important de prendre en compte le fait que les « baby » boomers entrent aujourd\'hui dans le champ de l\'âge et qu'on prévoit que le nombre de décès annuel, parfaitement stable depuis 1950, va augmenter de 50 % d\'ici 2050, amenant un développement considérable du besoin d\'accompagnement de la fin de vie. Elle lui demande donc ce que le Gouvernement entend mettre en place pour permettre le développement de cette filière majeure pour cet accompagnement de la fin de vie.", "reponse": "", "motif_retrait": "", "auteur": "Michèle Delaunay"}

        data = requests.get(expected_result['source']).content
        parsing_result = parse_question(expected_result['source'], data)

        self.assertDictEqual(expected_result, parsing_result)

    def test_question_parsing_with_table(self):
        expected_result = {"source": "http://questions.assemblee-nationale.fr/q14/14-47351QE.htm", "legislature": "14", "type": "QE", "numero": "47351", "date_question": "2014-01-07", "date_retrait": "", "date_reponse": "2014-05-13", "date_signalement": "2014-04-15", "date_cht_attr": "2014-04-03", "page_question": "18", "page_reponse": "3858", "ministere_attribue": "Défense", "ministere_interroge": "Défense", "tete_analyse": "équipements", "analyse": "équipements militaires. vieillissement. bilan", "rubrique": "défense", "question": "M. François Cornut-Gentille interroge M. le ministre de la défense sur les équipements des unités du génie de l\'armée de terre. Afin d\'évaluer le coût du vieillissement des équipements militaires, il lui demande de préciser le nombre et le taux de disponibilité au 31 décembre 2012 et au 31 décembre 2013, le coût du MCO pour l\'année 2013 et l\'âge moyen de chacun des équipements des unités du génie de l\'armée de terre.", "reponse": 'Les données relatives aux équipements du génie dédiés à l\'agencement de l\'espace terrestre sollicitées par l\'honorable parlementaire figurent dans le tableau suivant :<!-- DEBTAB --><div align=\\"center\\"><center><table border=\\"1\\"><tr> <th rowspan=\'2\\"\'>TYPE DE MATÉRIEL</th> <th colspan=\\"2\\">NOMBRE DE MATÉRIEL<br>en service</br></th> <th colspan=\\"2\\">TAUX DE DISPONIBILITÉ<br>moyen (en %)</br></th> <th rowspan=\'2\\"\'>ÂGE MOYEN<br>des matériels</br>(en années)</th> <th rowspan=\'2\\"\'>COÛT UNITAIRE DU MAINTIEN<br>en condition opérationnelle en 2013</br>(en euros)</th> </tr><tr> <th>au<br>31-12-2012</br></th> <th>au<br>31-12-2013</br></th> <th>sur la durée<br>de l\'année 2012</br></th> <th>sur la durée<br>de l\'année 2013</br></th> </tr><tr> <td align=\\"center\\">AMX30B2 DT<br>(char télécommandé, équipé d\'outils de déminage pour permettre la création de brèches)</br></td> <td align=\\"center\\">10</td> <td align=\\"center\\">10</td> <td align=\\"center\\">23,30</td> <td align=\\"center\\">37,60</td> <td align=\\"center\\">12</td> <td align=\\"center\\">194 588</td> </tr><tr> <td align=\\"center\\">BUFFALO<br>(équipement de protection contre les engins explosifs)</br></td> <td align=\\"center\\">5</td> <td align=\\"center\\">5</td> <td align=\\"center\\">44,50</td> <td align=\\"center\\">25,40</td> <td align=\\"center\\">5</td> <td align=\\"center\\">30 262</td> </tr><tr> <td align=\\"center\\">DISPERSEUR<br>(équipement permettant la réalisation rapide d\'un champ de mines antichars)</br></td> <td align=\\"center\\">18</td> <td align=\\"center\\">15</td> <td align=\\"center\\">46,30</td> <td align=\\"center\\">40,30</td> <td align=\\"center\\">16</td> <td align=\\"center\\">pas de marché</td> </tr><tr> <td align=\\"center\\">EBG<br>(engin destiné à appuyer les unités blindées en zone avant)</br></td> <td align=\\"center\\">42</td> <td align=\\"center\\">42</td> <td align=\\"center\\">22,00</td> <td align=\\"center\\">24,90</td> <td align=\\"center\\">20</td> <td align=\\"center\\">190 013</td> </tr><tr> <td align=\\"center\\">EFA<br>(engin amphibie et ambidrome destiné à faire franchir tous les véhicules en dotation dans l\'armée de terre)</br></td> <td align=\\"center\\">30</td> <td align=\\"center\\">30</td> <td align=\\"center\\">30,80</td> <td align=\\"center\\">37,40</td> <td align=\\"center\\">25</td> <td align=\\"center\\">200 000</td> </tr><tr> <td align=\\"center\\">EGAME<br>(aide au déploiement - franchissement de brèches, amélioration du terrain, terrassement, création et amélioration de plateformes)</br></td> <td align=\\"center\\">35</td> <td align=\\"center\\">35</td> <td align=\\"center\\">63,50</td> <td align=\\"center\\">53,70</td> <td align=\\"center\\">5</td> <td align=\\"center\\">228 400</td> </tr><tr> <td align=\\"center\\">EGRAP<br>(aide au déploiement -aménagement et protection du terrain)</br></td> <td align=\\"center\\">138</td> <td align=\\"center\\">138</td> <td align=\\"center\\">67,90</td> <td align=\\"center\\">53,70</td> <td align=\\"center\\">4</td> <td align=\\"center\\">2 756</td> </tr><tr> <td align=\\"center\\">EMAD<br>(aide au déploiement - aménagement et protection du terrain)</br></td> <td align=\\"center\\">45</td> <td align=\\"center\\">45</td> <td align=\\"center\\">32,70</td> <td align=\\"center\\">28,10</td> <td align=\\"center\\">17</td> <td align=\\"center\\">12 191</td> </tr><tr> <td align=\\"center\\">MADEZ<br>(matériel de déminage de zone destiné à permettre le déploiement et l\'installation d\'unités)</br></td> <td align=\\"center\\">8</td> <td align=\\"center\\">8</td> <td align=\\"center\\">18,40</td> <td align=\\"center\\">19,50</td> <td align=\\"center\\">20</td> <td align=\\"center\\">3 700</td> </tr><tr> <td align=\\"center\\">MATEM<br>(aide au déploiement - matériel de traitement de l\'eau)</br></td> <td align=\\"center\\">10</td> <td align=\\"center\\">7</td> <td align=\\"center\\">0,00</td> <td align=\\"center\\">9,00</td> <td align=\\"center\\">20</td> <td align=\\"center\\">19 000</td> </tr><tr> <td align=\\"center\\">PFM<br>(aide au franchissement par la pose d\'un pont flottant) </br></td> <td align=\\"center\\">70</td> <td align=\\"center\\">70</td> <td align=\\"center\\">54,60</td> <td align=\\"center\\">50,00</td> <td align=\\"center\\">25</td> <td align=\\"center\\">6 143</td> </tr><tr> <td align=\\"center\\">SDPMAC<br>(système permettant de neutraliser, par le tir de roquettes, les mines antichars enfouies ou dispersées au sol)</br></td> <td align=\\"center\\">12</td> <td align=\\"center\\">12</td> <td align=\\"center\\">11,90</td> <td align=\\"center\\">9,20</td> <td align=\\"center\\">6</td> <td align=\\"center\\">200 000</td> </tr><tr> <td align=\\"center\\">SOUVIM 2<br>(véhicule de détection multifonctions pour l\'ouverture d\'itinéraires)</br></td> <td align=\\"center\\">8</td> <td align=\\"center\\">8</td> <td align=\\"center\\">71,10</td> <td align=\\"center\\">29,50</td> <td align=\\"center\\">4</td> <td align=\\"center\\">275 000</td> </tr><tr> <td align=\\"center\\">SPRAT<br>(aide au franchissement des coupures par la pose rapide de travures pour les véhicules chenillés ou à roues)</br></td> <td align=\\"center\\">8</td> <td align=\\"center\\">10</td> <td align=\\"center\\">100,00</td> <td align=\\"center\\">96,50</td> <td align=\\"center\\">2</td> <td align=\\"center\\">309 500</td> </tr><tr> <td align=\\"center\\">VAB Génie</td> <td align=\\"center\\">314</td> <td align=\\"center\\">302</td> <td align=\\"center\\">43,10</td> <td align=\\"center\\">36,70</td> <td align=\\"center\\">30</td> <td align=\\"center\\">28 972</td> </tr><tr> <td align=\\"center\\">VBHP<br>(véhicule blindé d\'accompagnement des détachements - ouverture d\'itinéraires piégés)</br></td> <td align=\\"center\\">15</td> <td align=\\"center\\">14</td> <td align=\\"center\\">70,30</td> <td align=\\"center\\">11,30</td> <td align=\\"center\\">4</td> <td align=\\"center\\">125 000</td> </tr></table></center></div><!-- FINTAB -->', "motif_retrait": "", "auteur": "François Cornut-Gentille"}

        data = requests.get(expected_result['source']).content
        parsing_result = parse_question(expected_result['source'], data)

        self.assertDictEqual(expected_result, parsing_result)

    def test_parsing_search_result(self):
        url = 'http://www2.assemblee-nationale.fr/recherche/resultats_questions'
        response = requests.post(url, data={'legislature': 13, 'limit': 5})
        parsing_result = parse_question_search_result(url, response.content)

        self.assertEquals(138598, parsing_result.total_count)
        # always size at 25
        self.assertEquals(5, len(parsing_result.results))


if __name__ == '__main__':
    unittest.main()